#!/usr/bin/make -f
# -*- makefile -*-
# Sample debian/rules that uses debhelper.
#
# This file was originally written by Joey Hess and Craig Small.
# As a special exception, when this file is copied by dh-make into a
# dh-make output file, you may use that output file without restriction.
# This special exception was added by Craig Small in version 0.37 of dh-make.
#
# Modified to make a template file for a multi-binary package with separated
# build-arch and build-indep targets  by Bill Allombert 2001

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

export PROGNAME=centreon
export PROGVERSION=2.1.8

# Use dpatch
include /usr/share/dpatch/dpatch.make

base:=debian/centreon
sharedir=${base}/usr/share/centreon
sourcedir=${PROGNAME}-${PROGVERSION}


configure: configure-stamp
configure-stamp:
	@echo "Doing $@"
	dh_testdir
	# Add here commands to configure the package.
	tar xzf ${PROGNAME}-${PROGVERSION}.tar.gz
	mv ${PROGNAME}-${PROGVERSION} SOURCE_DIR
	touch configure-stamp
	find SOURCE_DIR -type f | xargs sed -i -f debian/centreon2.macrosreplacement

#Architecture 
build: build-arch build-indep

build-arch: build-arch-stamp
build-arch-stamp: configure-stamp 

	# Add here commands to compile the arch part of the package.
	#$(MAKE) 
	touch $@

build-indep: build-indep-stamp
build-indep-stamp: patch configure-stamp 

	# Add here commands to compile the indep part of the package.
	#$(MAKE) doc
	touch $@

clean: unpatch
	dh_testdir
	dh_testroot
	rm -f build-arch-stamp build-indep-stamp configure-stamp
	dh_clean -k

patch: configure-stamp patch-stamp
	@echo "Doing $@"

patch-stamp:
	@echo "Doing $@"
	dpatch apply-all -v
	# dpatch call-all -a=pkg-info >patch-stamp

unpatch:
	@echo "Doing $@"
	dpatch deapply-all
	rm -rf patch-stamp debian/patched configure-stamp

centreon2: 
	@echo "Doing $@"
	dh_testdir		-p$@
	dh_testroot		-p$@
	dh_installdirs		-p$@
	# install the SQL schemes
	mkdir -p debian/$@/mysql
	cp SOURCE_DIR/www/install/createTables.sql			debian/$@/mysql/1
	cp SOURCE_DIR/www/install/insertMacros.sql			debian/$@/mysql/2
	cp SOURCE_DIR/www/install/insertCmd-Tps.sql		debian/$@/mysql/3
	cp SOURCE_DIR/www/install/insertTopology.sql		debian/$@/mysql/4
	cp SOURCE_DIR/www/install/insertBaseConf.sql		debian/$@/mysql/5
	cp debian/misc/$@/createDefaultsUsers.sql	debian/$@/mysql/6
	cp debian/misc/$@/updateNagiosConfig.sql	debian/$@/mysql/7
	cp debian/misc/$@/updatePoller.sql		debian/$@/mysql/8

	touch debian/$@/mysql.sql
	for sqlfile in 1 2 3 4 5 6 7 8; do \
		test -e debian/$@/mysql/$${sqlfile} && \
			cat debian/$@/mysql/$${sqlfile} >> debian/$@/mysql.sql; \
	done 

	install -m 644 debian/$@/mysql.sql \
		debian/$@/usr/share/dbconfig-common/data/$@/install/mysql

	rm -f debian/$@/mysql.sql
	rm -rf debian/$@/mysql

	# Add update sql
	install -m 644 SOURCE_DIR/www/install/sql/centreon/Update-DB-2.1.3_to_2.1.4.sql \
		debian/$@/usr/share/dbconfig-common/data/$@/upgrade/mysql/2.1.4
	install -m 644 SOURCE_DIR/www/install/sql/centreon/Update-DB-2.1.4_to_2.1.5.sql \
		debian/$@/usr/share/dbconfig-common/data/$@/upgrade/mysql/2.1.5
	install -m 644 SOURCE_DIR/www/install/sql/centreon/Update-DB-2.1.5_to_2.1.6.sql \
		debian/$@/usr/share/dbconfig-common/data/$@/upgrade/mysql/2.1.6
	install -m 644 SOURCE_DIR/www/install/sql/centreon/Update-DB-2.1.6_to_2.1.7.sql \
		debian/$@/usr/share/dbconfig-common/data/$@/upgrade/mysql/2.1.7
	install -m 644 SOURCE_DIR/www/install/sql/centreon/Update-DB-2.1.7_to_2.1.8.sql \
		debian/$@/usr/share/dbconfig-common/data/$@/upgrade/mysql/2.1.8

	dh_install	-p$@ 

	# Change macros in www
	find debian/$@/usr/share/$@/www/ -name "*.php" -exec \
		sed -i 's|@CENTREON_ETC@|/etc/centreon2|g;s|@CENTREON_GENDIR@|/var/cache/centreon2|g' {} \;
	sed -i 's|@CENTREON_ETC@|/etc/centreon2|g' \
		debian/$@/usr/share/$@/cron/centAcl.php
	find debian/$@/usr/share/$@/www/ -name "*.php" -exec \
		sed -i 's|@CENTREON_LOG@|/var/log/centreon2|g' {} \;

	# Change macros in cron
	find debian/$@/usr/share/$@/cron/ -type f -exec \
		sed -i 's|@CENTREON_LOG@|/var/log/centreon2|g' {} \;

centreon2-centstorage:
	@echo "Doing $@"
	dh_testdir		-p$@
	dh_testroot		-p$@
	dh_installdirs		-p$@

	# install the SQL schemes
	mkdir debian/$@/mysql
	touch debian/$@/mysql.sql
	cp SOURCE_DIR/www/install/createTablesCentstorage.sql	debian/$@/mysql/1
	cp debian/misc/$@/grantCentUserOnCtsg.sql	debian/$@/mysql/2
	cp debian/misc/$@/updateCstgConfig.sql		debian/$@/mysql/3

	for sqlfile in 1 2 3; do \
		test -e debian/$@/mysql/$${sqlfile} && \
			cat debian/$@/mysql/$${sqlfile} >> debian/$@/mysql.sql; \
	done 

	install -m 644 debian/$@/mysql.sql \
		debian/$@/usr/share/dbconfig-common/data/$@/install/mysql

	rm -f debian/$@/mysql.sql
	rm -rf debian/$@/mysql

	# Add update sql
	install -m 644 SOURCE_DIR/www/install/sql/centstorage/Update-CSTG-2.1.2_to_2.1.3.sql \
		debian/$@/usr/share/dbconfig-common/data/$@/upgrade/mysql/2.1.3
	install -m 644 SOURCE_DIR/www/install/sql/centstorage/Update-CSTG-2.1.3_to_2.1.4.sql \
		debian/$@/usr/share/dbconfig-common/data/$@/upgrade/mysql/2.1.4
	install -m 644 SOURCE_DIR/www/install/sql/centstorage/Update-CSTG-2.1.4_to_2.1.5.sql \
		debian/$@/usr/share/dbconfig-common/data/$@/upgrade/mysql/2.1.5
	install -m 644 SOURCE_DIR/www/install/sql/centstorage/Update-CSTG-2.1.5_to_2.1.6.sql \
		debian/$@/usr/share/dbconfig-common/data/$@/upgrade/mysql/2.1.6
	install -m 644 SOURCE_DIR/www/install/sql/centstorage/Update-CSTG-2.1.6_to_2.1.7.sql \
		debian/$@/usr/share/dbconfig-common/data/$@/upgrade/mysql/2.1.7
	install -m 644 SOURCE_DIR/www/install/sql/centstorage/Update-CSTG-2.1.7_to_2.1.8.sql \
		debian/$@/usr/share/dbconfig-common/data/$@/upgrade/mysql/2.1.8

	dh_install	-p$@ 

	# Change macros for logAnalyser
	sed -e 's|@CENTREON_ETC@|/etc/centreon2/centstorage|g' \
	    -e 's|@CENTREON_LOG@|/var/log/centreon2|g' \
	    -e 's|@CENTREON_VARLIB@|/var/lib/centreon2-centstorage|g' \
	    -i debian/$@/usr/sbin/logAnalyser

	# Change macros for nagiosPerfTrace
	sed -e 's|@CENTREON_ETC@|/etc/centreon2/centstorage|g' \
	    -e 's|@CENTSTORAGE_LIB@|/var/lib/centreon2-centstorage|g' \
	    -e 's|@NAGIOS_USER@|nagios|g;s|@NAGIOS_GROUP@|nagios|g' \
	    -i debian/$@/usr/sbin/nagiosPerfTrace

	# Change macros for archiveDayLog
	sed -e 's|@CENTREON_ETC@|/etc/centreon2/centstorage|g' \
	    -i debian/$@/usr/sbin/archiveDayLog

	# Change macros for centstorage
	sed -e 's|@CENTREON_LOG@|/var/log/centreon2|g' \
	    -e 's|@CENTREON_RUNDIR@|/var/run/centreon2|g' \
	    -e 's|@CENTREON_ETC@|/etc/centreon2/centstorage|g' \
	    -e 's|@RRD_PERL@|/usr/lib/perl5|g' \
	    -i debian/$@/usr/sbin/centstorage

centreon2-centcore:
	@echo "Doing $@"
	dh_testdir		-p$@
	dh_testroot		-p$@
	dh_installdirs		-p$@

	dh_install		-p$@ 

centreon2-plugins:
	@echo "Doing $@"
	dh_testdir		-p$@
	dh_testroot		-p$@
	dh_installdirs		-p$@

	dh_install		-p$@ 

	for file in debian/$@/usr/lib/nagios/plugins/* ; do \
		sed -e 's|@NAGIOS_PLUGINS@|/usr/lib/nagios/plugins|g' \
		    -e 's|@CENTPLUGINS_TMP@|/var/lib/centreon2-centplugins|g' \
		    -i $${file} ; \
	done

	sed -e 's|@NAGIOS_VAR@|/tmp|' \
	    -i debian/$@/usr/lib/nagios/plugins/process-service-perfdata

	sed -e 's|@INSTALL_DIR_NAGIOS@|/usr/share/@@nagios_version@@|' \
	    -e 's|@NAGIOS_ETC@|/etc/centreon2/nagioscfg|' \
	    -i debian/$@/usr/lib/nagios/plugins/centreon.conf

	sed -e 's|@RRDTOOL_PERL_LIB@|/usr/lib/perl5|' \
	    -i debian/$@/usr/lib/nagios/plugins/centreon.pm

	# change right on all plugins
	chmod 755 debian/$@/usr/lib/nagios/plugins/*


centreon2-plugins-traps:
	@echo "Doing $@"
	dh_testdir		-p$@
	dh_testroot		-p$@
	dh_installdirs		-p$@

	dh_install		-p$@ 

centreon2-ndodb:
	@echo "Doing $@"
	dh_testdir		-p$@
	dh_testroot		-p$@
	dh_installdirs		-p$@

	mkdir debian/$@/mysql
	touch debian/$@/mysql.sql
	cp SOURCE_DIR/www/install/createNDODB.sql			debian/$@/mysql/1
	cp debian/misc/$@/updateNdo2cfg.sql		debian/$@/mysql/2

	for sqlfile in 1 2 ; do \
		test -e debian/$@/mysql/$${sqlfile} && \
			cat debian/$@/mysql/$${sqlfile} >> debian/$@/mysql.sql; \
	done 

	install -m 644 debian/$@/mysql.sql \
		debian/$@/usr/share/dbconfig-common/data/$@/install/mysql

	rm -f debian/$@/mysql.sql
	rm -rf debian/$@/mysql

	# Add update sql
	install -m 644 SOURCE_DIR/www/install/sql/brocker/Update-NDO-2.1.2_to_2.1.3.sql \
		debian/$@/usr/share/dbconfig-common/data/$@/upgrade/mysql/2.1.3
	install -m 644 SOURCE_DIR/www/install/sql/brocker/Update-NDO-2.1.3_to_2.1.4.sql \
		debian/$@/usr/share/dbconfig-common/data/$@/upgrade/mysql/2.1.4
	install -m 644 SOURCE_DIR/www/install/sql/brocker/Update-NDO-2.1.4_to_2.1.5.sql \
		debian/$@/usr/share/dbconfig-common/data/$@/upgrade/mysql/2.1.5
	install -m 644 SOURCE_DIR/www/install/sql/brocker/Update-NDO-2.1.5_to_2.1.6.sql \
		debian/$@/usr/share/dbconfig-common/data/$@/upgrade/mysql/2.1.6
	install -m 644 SOURCE_DIR/www/install/sql/brocker/Update-NDO-2.1.6_to_2.1.7.sql \
		debian/$@/usr/share/dbconfig-common/data/$@/upgrade/mysql/2.1.7
	install -m 644 SOURCE_DIR/www/install/sql/brocker/Update-NDO-2.1.7_to_2.1.8.sql \
		debian/$@/usr/share/dbconfig-common/data/$@/upgrade/mysql/2.1.8

	dh_install		-p$@ 

install-clean:
	@echo "Doing $@"
	dh_clean -k


install: install-clean centreon2 centreon2-centcore centreon2-centstorage centreon2-plugins centreon2-ndodb build
	@echo "Doing $@"
	dh_testdir
	dh_testroot
	#dh_clean -k 
	dh_installdirs	-pcentreon2-doc

	# Add here commands to install the indep part of the package into
	# debian/<package>-doc.
	#INSTALLDOC#
	dh_install	-pcentreon2-doc

binary-arch:
# Must not depend on anything. This is to be called by
# binary-arch/binary-indep
# in another 'make' thread.
binary-indep: build install
	@echo "Doing $@"
	dh_testdir
	dh_testroot
	dh_installchangelogs	SOURCE_DIR/CHANGELOG
	dh_installdocs          # ${PROGNAME}-${PROGVERSION}/CHANGELOG ${PROGNAME}-${PROGVERSION}/README ${PROGNAME}-${PROGVERSION}/INSTALL
	dh_installdebconf
	dh_installlogrotate	-pcentreon2 
#	dh_installlogcheck
	cp SOURCE_DIR/tmpl/install/centstorage.init.d debian/centreon2-centstorage.centstorage.init
	cp SOURCE_DIR/tmpl/install/centcore.init.d debian/centreon2-centcore.centcore.init
	dh_installinit 		-pcentreon2-centstorage	--name=centstorage --no-start
	dh_installinit 		-pcentreon2-centcore	--name=centcore
	dh_installcron 		-pcentreon2		--name=centreon2
	dh_installcron 		-pcentreon2-centstorage	--name=centstorage
	dh_link
	dh_compress
	dh_fixperms
#	dh_perl
	dh_installdeb
	dh_gencontrol
	dh_md5sums
	dh_builddeb

binary:  binary-indep

.PHONY: build clean binary-indep binary-arch binary install configure patch \

